name: CI - Backend Services (Prod)

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+-llm-api"
      - "v[0-9]+.[0-9]+.[0-9]+-mcp-tools"
      - "v[0-9]+.[0-9]+.[0-9]+-media-api"
      - "v[0-9]+.[0-9]+.[0-9]+-response-api"
      - "v[0-9]+.[0-9]+.[0-9]+-memory-tools"
      - "v[0-9]+.[0-9]+.[0-9]+-vector-store"
      - "v[0-9]+.[0-9]+.[0-9]+-realtime-api"

jobs:
  build-llm-api:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-llm-api')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/llm-api/Dockerfile
      context: services/llm-api
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/llm-api:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-mcp-tools:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-mcp-tools')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/mcp-tools/Dockerfile
      context: services/mcp-tools
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/mcp-tools:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-media-api:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-media-api')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/media-api/Dockerfile
      context: services/media-api
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/media-api:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-response-api:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-response-api')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/response-api/Dockerfile
      context: services/response-api
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/response-api:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-memory-tools:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-memory-tools')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/memory-tools/Dockerfile
      context: services/memory-tools
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/memory-tools:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-vector-store:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-vector-store')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/mcp-tools/tools/vector-store-service/Dockerfile
      context: services/mcp-tools/tools/vector-store-service
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/vector-store-service:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}

  build-realtime-api:
    if: startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-realtime-api')
    uses: ./.github/workflows/_reusable-docker.yml
    secrets: inherit
    with:
      runs-on: ubuntu-24-04-docker
      docker-file: services/realtime-api/Dockerfile
      context: services/realtime-api
      registry-url: registry.menlo.ai
      tags: registry.menlo.ai/jan-server/realtime-api:prod-${{ github.sha }}
      is_push: true
      build-args: |
        VERSION_TAG=prod-${{ github.sha }}