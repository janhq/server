---
title: Operations & Troubleshooting
description: Monitoring, debugging, and common issues
full: false
---

# Operations & Troubleshooting

This guide covers observability setup, operational best practices, and solutions to common issues you may encounter running Jan Server.

---

## Observability & Monitoring

Jan Server ships an optional observability stack composed of OpenTelemetry Collector, Prometheus, Jaeger, and Grafana. Use it locally for debugging or adapt the configuration for production.

### Quick Start

```bash
# Start Prometheus, Grafana, Jaeger, and the OTEL Collector
make monitor-up

# View logs for the monitoring stack
make monitor-logs

# Stop (preserve volumes)
make monitor-down

# Stop and wipe data
make monitor-clean
```

Dashboards:
- **Grafana**: http://localhost:3001 (`admin/admin`).
- **Prometheus**: http://localhost:9090.
- **Jaeger**: http://localhost:16686.

### Architecture

```
Services (llm-api, response-api, media-api, mcp-tools)
    |  OTLP (HTTP 4318 / gRPC 4317)
    v
OpenTelemetry Collector
    |--> Prometheus (scrapes metrics endpoint)
    |--> Jaeger (trace storage + search)
    v
Grafana (aggregated dashboards + alerting)
```

### Environment Variables

```bash
# OTLP ports
OTEL_HTTP_PORT=4318
OTEL_GRPC_PORT=4317

# Observability UI ports
PROMETHEUS_PORT=9090
GRAFANA_PORT=3001
JAEGER_UI_PORT=16686

# Service-side telemetry switches
OTEL_ENABLED=true
OTEL_SERVICE_NAME=llm-api
OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
```

### Enabling Telemetry per Service

1. Set `OTEL_ENABLED=true` and `OTEL_EXPORTER_OTLP_ENDPOINT` in `.env` or deployment manifests.
2. Restart the service (`make restart-api`, `docker compose restart llm-api`, etc.).
3. Confirm metrics appear under Prometheus targets and traces show up in Jaeger.

### Prometheus Queries

```bash
# Request rate per service
rate(http_server_requests_total[5m])

# Error rate
rate(http_server_requests_total{status=~"5.."}[5m])

# Latency p95
histogram_quantile(0.95, sum by (le) (rate(http_server_request_duration_seconds_bucket[5m])))
```

### Production Tips

1. Change the default Grafana admin password (`GRAFANA_ADMIN_PASSWORD`).
2. Configure TLS or run the monitoring stack behind your corporate ingress.
3. Enable alerting in Grafana or Prometheus to notify on service health issues.
4. Consider remote storage for Prometheus and an external Jaeger backend (Elasticsearch, Cassandra) for long-term retention.

### Troubleshooting Observability

- **No metrics**: ensure the OTEL Collector container is running (`docker compose -f docker/observability.yml ps otel-collector`) and Prometheus targets show `UP`.
- **No traces**: check `make monitor-logs | Select-String jaeger` for exporter errors and confirm services have `OTEL_ENABLED=true`.
- **Grafana datasources failing**: log into Grafana → Configuration → Data Sources → Test. Restart Grafana if provisioning files changed.
- **High disk usage**: adjust Prometheus retention flags in `docker/observability.yml` (for example, `--storage.tsdb.retention.time=7d`).

---

## Troubleshooting Guide

Common issues observed in production and development, with solutions.

### Quick Fix Matrix

| Problem | Symptoms | First Actions |
|---------|----------|---------------|
| Services fail to start | Containers crash, port conflicts | `make logs`, `docker ps`, inspect `.env`. |
| Database errors | `connection refused`, missing tables | `docker compose logs api-db`, `make db-migrate`, verify credentials. |
| Auth failures | `401 Unauthorized`, guest login errors | Check Kong + Keycloak logs, refresh tokens, ensure clocks synced. |
| Docker issues | Compose hangs, volumes stale | `docker system prune`, `make down-clean`, reinstall Docker Desktop if needed. |
| Kubernetes issues | Pods CrashLoop, ImagePullBackOff | `kubectl describe pod`, ensure secrets/configmaps exist. |
| Performance issues | Slow responses, high CPU/RAM | `docker stats`, Prometheus dashboards, adjust connection pools. |

### Service Startup Issues

#### Port Already in Use

```bash
# Linux/macOS
lsof -i:8000
lsof -i:8080

# Windows
netstat -ano | findstr 8000
```

Stop the conflicting process or change ports in `.env` (`LLM_API_HTTP_PORT=8081`, etc.).

#### Container Crashes Immediately

```bash
make logs-api         # or make logs-mcp
docker logs <container-name>
```

Common causes: missing env vars, bad database credentials, external services unavailable.

### Database Issues

```bash
# Confirm Postgres is running
docker ps | grep api-db

# Open psql shell
docker exec -it jan-server-api-db-1 psql -U jan_user -d jan_llm_api

# Run migrations
make db-migrate
```

If the database does not exist, create it manually or run `make db-reset`.

### Authentication Issues

- `401 Unauthorized`: Token expired; fetch a new one using `curl -X POST http://localhost:8000/llm/auth/guest-login`.
- `Token validation failed`: confirm `ISSUER` and `JWKS_URL` values match Keycloak realm and services have restarted after changes.
- API key invalid: ensure the key still appears under `GET /auth/api-keys` and Kong can reach LLM API at `http://llm-api:8080`.

### Docker & Compose Problems

```bash
# Clean up dangling resources
docker system prune -f

# Remove volumes when needed
make down-clean

# Validate Compose files
docker compose config
```

If Docker Desktop misbehaves, restart it or reinstall after purging WSL data (Windows).

### Kubernetes Problems

```bash
kubectl get pods -n jan-server
kubectl describe pod <name> -n jan-server
kubectl logs -n jan-server deploy/jan-server-llm-api
```

- **ImagePullBackOff**: Ensure images exist or preload them (minikube) and set correct registry credentials.
- **CrashLoopBackOff**: Inspect env vars/secrets in the deployment; compare to Compose `.env`.
- **Service not reachable**: Verify ingress, service IPs, and port-forward to Kong for debugging.

### Performance Issues

```bash
# Real-time stats
docker stats

# Database profiling
```

Solutions:
- Scale horizontally (add replicas in Kubernetes or more workers for Response API).
- Increase connection pool sizes in configuration.
- Review Prometheus metrics for bottlenecks.
- Enable observability and review Jaeger traces for slow endpoints.

---

## Related Documentation

- [Development Guide](/docs/guides/development) - Local development workflows
- [Deployment Guide](/docs/guides/deployment) - Production deployment steps
- [Development Modes](/docs/guides/dev-modes) - Hybrid development setup
- [Configuration Overview](/docs/configuration/overview) - System configuration
