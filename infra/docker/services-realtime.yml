# Realtime API Service (LiveKit-based real-time communication)

services:
  realtime-api:
    build: ../../services/realtime-api
    restart: unless-stopped
    env_file:
      - ${ENV_FILE:-../../.env}
    environment:
      # HTTP Server
      REALTIME_API_PORT: ${REALTIME_API_PORT:-8186}
      SERVICE_NAME: realtime-api
      ENVIRONMENT: ${ENVIRONMENT:-development}

      # LiveKit Configuration
      LIVEKIT_WS_URL: ${LIVEKIT_WS_URL:-wss://your-livekit-server.com}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:-}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:-}
      LIVEKIT_TOKEN_TTL: ${LIVEKIT_TOKEN_TTL:-24h}

      # Session Management
      SESSION_STALE_TTL: ${SESSION_STALE_TTL:-10m}
      SESSION_CLEANUP_INTERVAL: ${SESSION_CLEANUP_INTERVAL:-15s}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SHUTDOWN_TIMEOUT: ${SHUTDOWN_TIMEOUT:-10s}

      # Authentication
      AUTH_ENABLED: ${REALTIME_AUTH_ENABLED:-true}
      ISSUER: ${ISSUER:-http://localhost:8085/realms/jan}
      AUDIENCE: ${AUDIENCE:-account}
      JWKS_URL: ${JWKS_URL:-http://keycloak:8085/realms/jan/protocol/openid-connect/certs}

      # Observability
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
    ports:
      - "${REALTIME_API_PORT:-8186}:${REALTIME_API_PORT:-8186}"
    depends_on:
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:${REALTIME_API_PORT:-8186}/healthz"]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles: ["realtime", "full"]
