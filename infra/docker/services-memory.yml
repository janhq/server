# Memory Tools Service

services:
  # Redis cache for embedding vectors (optional)
  redis-memory:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]
    ports:
      - "${REDIS_MEMORY_PORT:-6379}:6379"
    volumes:
      - redis-memory-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    profiles: ["memory-redis", "full"]

  bge-m3:
    build:
      context: ./bge-m3-mock
      dockerfile: Dockerfile
    environment:
      PORT: ${EMBEDDING_PORT:-8091}
    ports:
      # Expose embedding mock on a host port that won't collide with MCP tools (8091)
      - "${EMBEDDING_HOST_PORT:-8092}:${EMBEDDING_PORT:-8091}"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8091/health')"]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles: ["memory-mock"]

  memory-tools:
    build: ../../services/memory-tools
    restart: unless-stopped
    env_file:
      - ${ENV_FILE:-.env}
    environment:
      # HTTP Server
      MEMORY_TOOLS_PORT: ${MEMORY_TOOLS_PORT:-8090}
      
      # Database (PostgreSQL with pgvector)
      DB_POSTGRESQL_WRITE_DSN: ${MEMORY_DB_POSTGRESQL_WRITE_DSN:-postgres://${POSTGRES_USER:-jan_user}:${POSTGRES_PASSWORD:-jan_password}@${POSTGRES_HOST:-api-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-jan_llm_api}?sslmode=disable}
      DB_POSTGRESQL_READ1_DSN: ${MEMORY_DB_POSTGRESQL_READ1_DSN:-}
      
      # BGE-M3 Embedding Service
      EMBEDDING_SERVICE_URL: ${EMBEDDING_SERVICE_URL:-http://bge-m3:8091}
      
      # Redis Cache
      EMBEDDING_CACHE_TYPE: ${EMBEDDING_CACHE_TYPE:-memory}
      EMBEDDING_CACHE_REDIS_URL: ${EMBEDDING_CACHE_REDIS_URL:-redis://redis:6379/3}
      
      # Logging
      LOG_LEVEL: ${MEMORY_LOG_LEVEL:-info}
      LOG_FORMAT: ${MEMORY_LOG_FORMAT:-json}
      
      # Observability
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-memory-tools}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318}
    ports:
      - "${MEMORY_TOOLS_PORT:-8090}:${MEMORY_TOOLS_PORT:-8090}"
    depends_on:
      api-db:
        condition: service_healthy
    volumes:
      - ../services/memory-tools/configs:/app/config:ro
      - ../services/memory-tools/migrations:/app/migrations:ro
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:${MEMORY_TOOLS_PORT:-8090}/healthz"]
      interval: 10s
      timeout: 5s
      retries: 10
    profiles: ["memory", "full"]

volumes:
  redis-memory-data:

