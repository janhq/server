_format_version: "3.0"
_transform: true

# Kong configuration for dev-full mode
# Routes to services in Docker or on host.docker.internal
# Allows stopping Docker services and running them manually on host

consumers:
  - username: kong-anon-jwt
    custom_id: anon-jwt
    tags: [anonymous, auth, fallback]
  - username: keycloak-issuer
    custom_id: keycloak-jwt
    tags: [auth, jwt, keycloak]

jwt_secrets:
  - consumer: keycloak-issuer
    algorithm: RS256
    key: http://localhost:8085/realms/jan
    rsa_public_key: |
      -----BEGIN PUBLIC KEY-----
      MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAks4bK7EqsKVvrW6F8gRD
      izRuGFzhfZVdHImVbmwavyK+yGrxVR5BOfbAYZy6/LnLei3aCmYbwKNgV+BU8Lch
      +USX/BPpHswRXqf/GcBcdwAhqxAtwoKFG8KwTORP/RZGbVxOMS9D9T6iHPQmT7Md
      4FyvHwTx7BwPx5oMIEOnur+NNaTsECN3cGR21SAnCtNCl188D3ubTsjUwERp6B4E
      p2sVXsTDzT0ZOYbmmZiZJ59Fvk+0UNMn2uQyAj+j7lv15g6GtNSlG1DBnRKEVbOz
      C50TfRUcCpQTrS8FkTTS0Pc/9MCOCHy9YDDDhdEuI5dvo9y9QUTIHPx4AhSubE0C
      bwIDAQAB
      -----END PUBLIC KEY-----

plugins:
  - name: rate-limiting
    tags: [global, security, rate]
    config:
      minute: 600
      hour: 10000
      policy: local
      limit_by: ip
      fault_tolerant: true
  - name: request-transformer
    tags: [global, security, transformer]
    config:
      add:
        headers:
          - "X-Gateway-Auth: kong"
          - "X-Gateway-Version: 3.5"
          - "X-Dev-Mode: full"

# Service upstreams - supports both Docker network and host.docker.internal
# To run service manually on host:
# 1. Stop Docker service: docker compose stop llm-api
# 2. Run on host: cd services/llm-api && go run ./cmd/server
# 3. Kong will route to host.docker.internal:8080

upstreams:
  - name: llm-api-upstream
    algorithm: round-robin
    targets:
      - target: host.docker.internal:8080
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3
      passive:
        healthy:
          successes: 3
        unhealthy:
          http_failures: 3

  - name: media-api-upstream
    algorithm: round-robin
    targets:
      - target: host.docker.internal:8285
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3

  - name: response-api-upstream
    algorithm: round-robin
    targets:
      - target: host.docker.internal:8082
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3

  - name: mcp-tools-upstream
    algorithm: round-robin
    targets:
      - target: host.docker.internal:8091
        weight: 100
    healthchecks:
      active:
        type: http
        http_path: /healthz
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3

services:
  - name: llm-api-svc
    host: llm-api-upstream
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [llm, api]
    routes:
      - name: llm-api-proxy
        paths:
          - /llm
        strip_path: true
        path_handling: v0
        tags: [llm, api, protected]
        plugins:
          - name: jwt
            tags: [llm, api, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [llm, api, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: rate-limiting
            tags: [llm, api, rate]
            config:
              minute: 120
              policy: local
              limit_by: consumer
              fault_tolerant: true
          - name: cors
            tags: [llm, api, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id", "mcp-protocol-version", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-api-v1
        paths:
          - /v1
        strip_path: false
        path_handling: v0
        tags: [llm, api, v1, protected]
        plugins:
          - name: jwt
            tags: [llm, api, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [llm, api, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: rate-limiting
            tags: [llm, api, rate]
            config:
              minute: 120
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [llm, api, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id", "mcp-protocol-version", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-api-health
        paths:
          - /healthz
          - /readyz
        strip_path: false
        path_handling: v0
        methods: [GET]
        tags: [llm, health, public]
        plugins:
          - name: cors
            tags: [llm, health, cors]
            config:
              origins: ["*"]
              methods: ["GET", "OPTIONS"]
              headers: ["Content-Type"]
              exposed_headers: ["X-Request-Id"]
              credentials: false
              max_age: 3600

  - name: media-api-svc
    host: media-api-upstream
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [media, api]
    routes:
      - name: media-api-proxy
        paths: [/media]
        strip_path: true
        path_handling: v0
        tags: [media, protected]
        plugins:
          - name: jwt
            tags: [media, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [media, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: rate-limiting
            tags: [media, rate]
            config:
              minute: 60
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [media, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "X-Media-Service-Key", "Idempotency-Key", "X-Request-Id", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: llm-auth-svc
    host: llm-api-upstream
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [llm, auth]
    routes:
      - name: llm-auth-public
        paths:
          - /auth
        strip_path: false
        methods: [GET, POST, DELETE, OPTIONS]
        tags: [llm, auth, public]
        plugins:
          - name: cors
            tags: [llm, cors, public]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "POST", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
              
  - name: response-api-svc
    host: response-api-upstream
    connect_timeout: 900000
    write_timeout: 900000
    read_timeout: 900000
    retries: 3
    tags: [response, api]
    routes:
      - name: response-api-proxy
        paths: [/responses]
        strip_path: true
        path_handling: v0
        tags: [response, protected]
        plugins:
          - name: jwt
            tags: [response, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [response, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: rate-limiting
            tags: [response, rate]
            config:
              minute: 100
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [response, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id", "mcp-protocol-version", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: mcp-tools-rpc-svc
    host: mcp-tools-upstream
    path: /v1/mcp
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [mcp, rpc]
    routes:
      - name: mcp-tools-rpc
        paths: [/mcp]
        strip_path: true
        methods: ["POST", "OPTIONS"]
        path_handling: v0
        tags: [mcp, protected]
        plugins:
          - name: jwt
            tags: [mcp, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [mcp, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: rate-limiting
            tags: [mcp, rate]
            config:
              minute: 200
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [mcp, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["POST", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "mcp-protocol-version", "X-Tool-Call-ID", "X-Conversation-ID", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: mcp-tools-health-svc
    host: mcp-tools-upstream
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [mcp, health]
    routes:
      - name: mcp-tools-health
        paths: [/mcp/healthz, /mcp/readyz]
        strip_path: true
        methods: ["GET"]
        path_handling: v0
        tags: [mcp, health, protected]
        plugins:
          - name: jwt
            tags: [mcp, health, jwt]
            config:
              key_claim_name: iss
              claims_to_verify: ["exp", "nbf"]
              maximum_expiration: 3600
              secret_is_base64: false
              run_on_preflight: false
              anonymous: kong-anon-jwt
          - name: keycloak-apikey
            tags: [mcp, health, apikey]
            config:
              validation_url: "http://host.docker.internal:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: cors
            tags: [mcp, health, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://localhost:3001", "http://127.0.0.1", "http://127.0.0.1:3000", "http://127.0.0.1:3001", "http://127.0.0.1:8080", "http://localhost:8080", "https://chat-dev.jan.ai", "https://platform-dev.jan.ai", "https://api-gateway-dev.jan.ai", "https://chat.jan.ai", "https://platform.jan.ai"]
              methods: ["GET", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "X-Request-Id", "Accept"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
