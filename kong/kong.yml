_format_version: "3.0"
_transform: true

# Note: API key authentication moved to service level (llm-api)
# Kong in DB-less mode cannot manage consumers/credentials dynamically
# API keys are validated by llm-api service via Keycloak

plugins:
  - name: rate-limiting
    tags: [global, security, rate]
    config:
      minute: 600
      hour: 10000
      policy: local
      limit_by: ip
      fault_tolerant: true
  - name: request-transformer
    tags: [global, security, transformer]
    config:
      add:
        headers:
          - "X-Gateway-Auth: kong"
          - "X-Gateway-Version: 3.5"

services:
  - name: llm-api-svc
    url: http://llm-api:8080
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [llm, api]
    routes:
      - name: llm-auth-public
        paths:
          - /auth/guest-login
          - /auth/refresh-token
          - /auth/logout
          - /auth/validate-api-key
        strip_path: false
        methods: [GET, POST, OPTIONS]
        tags: [llm, auth, public]
        plugins:
          - name: cors
            tags: [llm, cors, public]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-auth-protected
        paths:
          - /auth
        strip_path: false
        tags: [llm, auth, protected]
        plugins:
          - name: jwt
            tags: [llm, auth, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [llm, auth, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [llm, auth, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [llm, auth, rate]
            config:
              minute: 60
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [llm, cors, protected]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-api-proxy
        paths:
          - /llm
        strip_path: true
        path_handling: v0
        tags: [llm, api, protected]
        plugins:
          - name: jwt
            tags: [llm, api, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [llm, api, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [llm, api, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [llm, api, rate]
            config:
              minute: 120
              policy: local
              limit_by: consumer
              fault_tolerant: true
          - name: cors
            tags: [llm, api, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-api-v1
        paths:
          - /v1
        strip_path: false
        path_handling: v0
        tags: [llm, api, v1, protected]
        plugins:
          - name: jwt
            tags: [llm, api, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [llm, api, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [llm, api, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [llm, api, rate]
            config:
              minute: 120
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [llm, api, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
      - name: llm-api-health
        paths:
          - /healthz
          - /readyz
        strip_path: false
        path_handling: v0
        methods: [GET]
        tags: [llm, health, public]
        plugins:
          - name: cors
            tags: [llm, health, cors]
            config:
              origins: ["*"]
              methods: ["GET", "OPTIONS"]
              headers: ["Content-Type"]
              exposed_headers: ["X-Request-Id"]
              credentials: false
              max_age: 3600

  - name: media-api-svc
    url: http://media-api:8285
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [media, api]
    routes:
      - name: media-api-proxy
        paths: [/media]
        strip_path: true
        path_handling: v0
        tags: [media, protected]
        plugins:
          - name: jwt
            tags: [media, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [media, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [media, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [media, rate]
            config:
              minute: 60
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [media, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: response-api-svc
    url: http://response-api:8082
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [response, api]
    routes:
      - name: response-api-proxy
        paths: [/responses]
        strip_path: true
        path_handling: v0
        tags: [response, protected]
        plugins:
          - name: jwt
            tags: [response, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [response, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [response, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [response, rate]
            config:
              minute: 100
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [response, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "Mcp-Session-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: mcp-tools-rpc-svc
    url: http://mcp-tools:8091/v1/mcp
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [mcp, rpc]
    routes:
      - name: mcp-tools-rpc
        paths: [/mcp]
        strip_path: true
        methods: ["POST", "OPTIONS"]
        path_handling: v0
        tags: [mcp, protected]
        plugins:
          - name: jwt
            tags: [mcp, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [mcp, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [mcp, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: rate-limiting
            tags: [mcp, rate]
            config:
              minute: 200
              policy: local
              limit_by: ip
              fault_tolerant: true
          - name: cors
            tags: [mcp, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["POST", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "Idempotency-Key", "X-Request-Id", "mcp-protocol-version"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600

  - name: mcp-tools-health-svc
    url: http://mcp-tools:8091
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    tags: [mcp, health]
    routes:
      - name: mcp-tools-health
        paths: [/mcp/healthz, /mcp/readyz]
        strip_path: true
        methods: ["GET"]
        path_handling: v0
        tags: [mcp, health, protected]
        plugins:
          - name: jwt
            tags: [mcp, health, jwt]
            config:
              secret_is_base64: false
              run_on_preflight: false
          - name: keycloak-apikey
            tags: [mcp, health, apikey]
            config:
              validation_url: "http://llm-api:8080/auth/validate-api-key"
              validation_timeout: 5000
              hide_credentials: true
              run_on_preflight: false
          - name: request-termination
            tags: [mcp, health, fallback]
            config:
              status_code: 401
              message: "Unauthorized: Valid JWT or API key required"
          - name: cors
            tags: [mcp, health, cors]
            config:
              origins: ["http://localhost", "http://localhost:3000", "http://127.0.0.1"]
              methods: ["GET", "OPTIONS"]
              headers: ["Authorization", "Content-Type", "X-API-Key", "X-Request-Id"]
              exposed_headers: ["X-Request-Id", "X-Gateway-Auth"]
              credentials: true
              max_age: 3600
